{"componentChunkName":"component---src-templates-post-template-tsx","path":"/gatsby-google-oauth-sam/","result":{"data":{"markdown":{"frontmatter":{"slug":"/gatsby-google-oauth-sam/","date":"2021.02.16","tags":["Gatsby","AWS"],"title":"Gatsbyで作成したブログにコメント機能をつけてみた","description":"Gatsbyで作成したブログにコメント機能をつけてみました。認証はGoogl Oauth 2.0、サーバーはAWSのAPI GatewayとLambda、DynamoDBを用いたサーバレスアーキテクチャという構成です。","thumbnail":{"name":"aws-gatsby-thumbnail","publicURL":"/static/ab2e967a4c014cf689efb211fbe2086c/aws-gatsby-thumbnail.png"}},"html":"<h2 id=\"これは何\" style=\"position:relative;\"><a href=\"#%E3%81%93%E3%82%8C%E3%81%AF%E4%BD%95\" aria-label=\"これは何 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>これは何</h2>\n<p>先日<a href=\"https://www.takigawa-memo.com\">自分のブログ</a>にコメント機能を実装しました。</p>\n<p>フロントエンドはGatsby.jsで作成し、GitHubPages上にデプロイしてます。<br>\nバックエンドはAWS上にAPI Gateway、Lambda(python)、Dynamo DBというサーバーレスな構成で作成しました。<br>\n認証はGoogleアカウントを用いたOauth認証を利用しています。</p>\n<p>はじめはバックエンドを、ろくに料金体系を調べもせずに、Spring Boot + Kotlinで作成しGKE上にデプロイしてみたのですが、\n可用性を全く考慮せずに最安値で構成しても毎日おおよそ900円程度のコストがかかってしまうことが判明したので急いでやめました。</p>\n<p>今回は改めてサーバレスな構成でコメント機能を実装するにあたり、\n主にバッグエンド側の実装で個人的に躓いた点をまとめていきたいと思います。</p>\n<h2 id=\"初めに\" style=\"position:relative;\"><a href=\"#%E5%88%9D%E3%82%81%E3%81%AB\" aria-label=\"初めに permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>初めに</h2>\n<p>ブログのようなWebサイトにコメント欄を設置する場合、自分で実装するのではなく、Disqusなどのサービスを利用するケースが多いようです。<br>\nユーザー認証やsession管理についても、自分で実装するのではなく、\nCognitoやFirebase Authenticationのような仕組みとSDKを用いた方が簡単でセキュリティ的にも安心です。</p>\n<p>今回コメント投稿機能を実装した理由は、Oauthによる認証の流れやsession管理\nについてより深く理解するためのHands On的な意味合いが大きいので、あらかじめご了承ください。</p>\n<p>また、普段自分は主にAndroidアプリを開発しており、Webフロントエンドやバックエンドについては鬼素人ですので、何か不備がありましたら指摘していただけると幸いです。\n&#x3C;- (コメント投稿機能を利用して!)</p>\n<h2 id=\"仕様\" style=\"position:relative;\"><a href=\"#%E4%BB%95%E6%A7%98\" aria-label=\"仕様 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>仕様</h2>\n<p>実現したかった機能は以下の通りです。</p>\n<ul>\n<li>記事に対してコメントを投稿できる。</li>\n<li>自分が投稿したコメントは削除できる。</li>\n<li>コメントを投稿するには、Googleアカウントによるログインが必要。</li>\n<li>ログインに成功したら、一意なユーザーidを発行し、Googleの認証サーバーから取得したユーザー名とemailアドレスと共にデータベースに保存する。</li>\n<li>refresh tokenを用いることで、サイトを訪れるたびにログインする必要が無いようにする。</li>\n<li>クライアントサイドから/loginパスに対してrefresh tokenをCookieにセットしたGETリクエストを投げると、sessionが開始される。</li>\n</ul>\n<h2 id=\"インフラ構成図\" style=\"position:relative;\"><a href=\"#%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E6%A7%8B%E6%88%90%E5%9B%B3\" aria-label=\"インフラ構成図 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>インフラ構成図</h2>\n<p>すごくシンプルです。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ca5d5d06bddde0c3ad3b7614d7ee846e/5a3c9/takigawa-memo-aws.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 70.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB4UlEQVQ4y4VTO4/TQBDOz+PPUFEhREGDaCgooKK4Cgkq7qoTEhQ0QMFdLtyJiwQ5K0o4O3HsxM6u9zG732knTuxEBkZa+bE732Nmp4dWeO/33tvf7f3t3uF3iN6/DoZwzsFa27nXJaLXpUaKCvF0jiSJobXmfwG0HeTcLodqUlZ4qMYYjWJZYjKKGTBfrpBmOYQQqKqKCfLVCo+evUD/6ifnpYsMyWzeWBZSolKKWYgIztGO5Ov3Czx5/jL4YELvHSt6f/oRyTzlM0W5xiLLG8uDq2uc9X9ACsGAYbNcFbDGIMtz/L6JaiLHZOHZrl9QLaVoFAaAebrggyFxMr1FFUoQFrldDY2x0MbWDjbg1lIQj62puil1kjEwxsASQR2fwJz1kasKcTxGluXQWgFOYpZKnHySmCabht1Mr3E+/NwAWsta2AKDaYPo/gPM3ryDAqDKFIoAFX1DcXQPo4sBHj6NMLjMGOTDl7d4ffy4ASzHQ8SjSVDOlkPRjTa7JhE5BE4Rj/Dn9BVMkUJpAtlg32MtCmTLtAH8dTvEeTTmH6HbUkq2HoqtlOIl1msY8gi3zdK2fhvCvYvNNq2Dr6u6bQxZqtU1i7vqXWtq0D16XWP0t2iP4OE8781y1zz/L7kr7gDdkD7B5GO2fAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"takigawa-memo-aws\"\n        title=\"takigawa-memo-aws\"\n        src=\"/static/ca5d5d06bddde0c3ad3b7614d7ee846e/5a190/takigawa-memo-aws.png\"\n        srcset=\"/static/ca5d5d06bddde0c3ad3b7614d7ee846e/772e8/takigawa-memo-aws.png 200w,\n/static/ca5d5d06bddde0c3ad3b7614d7ee846e/e17e5/takigawa-memo-aws.png 400w,\n/static/ca5d5d06bddde0c3ad3b7614d7ee846e/5a190/takigawa-memo-aws.png 800w,\n/static/ca5d5d06bddde0c3ad3b7614d7ee846e/5a3c9/takigawa-memo-aws.png 1169w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"google-oauth-20を用いた認証\" style=\"position:relative;\"><a href=\"#google-oauth-20%E3%82%92%E7%94%A8%E3%81%84%E3%81%9F%E8%AA%8D%E8%A8%BC\" aria-label=\"google oauth 20を用いた認証 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Google Oauth 2.0を用いた認証</h2>\n<p>基本的なOauth認証の仕組みについてはこちらの記事が非常に分かりやすく、参考になりました。<br>\n<a href=\"https://qiita.com/TakahikoKawasaki/items/e37caf50776e00e733be\">一番分かりやすい OAuth の説明 - Qiita</a></p>\n<p>WebサイトにおいてGoogleアカウントによるOauth認証を行う場合、クライアント側で処理を行うタイプと、バックエンド側で処理を行うタイプの二種類の方法があるようです。<br>\nざっくりと比較すると、クライアント側で処理する場合、</p>\n<ul>\n<li>ポップアップ画面を表示してログインを行う。</li>\n<li>ログインが完了すると、クライアント側でgapi.auth2というグローバル変数からユーザーに関する基本的な情報が取得できる。</li>\n<li>ユーザー情報をサーバーに送信する場合は、id tokenを送信して署名をチェックすることによりそれがGoogleの認証サーバーから発行されたものであることを確認できる。</li>\n</ul>\n<p>バックエンド側で処理する場合、</p>\n<ul>\n<li>Googleの認証エンドポイントにアクセスしてログインを行う。</li>\n<li>ログインが完了すると、クライアント側であらかじめ指定したURLに対してリダイレクトが行われる。その際に認証コードがURLのクエリパラメータとして付加される。</li>\n<li>バックエンド側では取得した認証コードやシークレットキーを用いてGoogleの認証エンドポイントに対してアクセスすることにより、access tokenやid tokenを取得する。</li>\n<li>取得したaccess tokenを用いて適当なGoogleのエンドポイントからユーザー情報を取得する。</li>\n</ul>\n<p>クライアント側で処理を行う方が簡単そうではあったのですが、ポップアップウィンドウが表示されるという挙動が気に入らなかったので、ログイン後はAPIサーバーにリダイレクトさせてバックエンド側で処理を行う方法で実装することにしました。</p>\n<p>以下、Googleアカウントでログインするためのボタンに対応するReactコンポーネントを記載します。</p>\n<div class=\"gatsby-code-title\">GoogleAuth.tsx</div>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-tsx line-numbers\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> Image <span class=\"token keyword\">from</span> <span class=\"token string\">'./Image'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">Props</span> <span class=\"token punctuation\">{</span>\n  slug<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> base_url <span class=\"token operator\">=</span> <span class=\"token string\">'https://accounts.google.com/o/oauth2/auth'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> clientId <span class=\"token operator\">=</span> <span class=\"token string\">'your_client_id'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> redirect_uri <span class=\"token operator\">=</span> <span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://www.example.com/path/to/callback'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> scope <span class=\"token operator\">=</span> <span class=\"token string\">'profile email'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> GoogleAuth<span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span><span class=\"token constant\">FC</span><span class=\"token operator\">&lt;</span>Props<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>slug<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> href <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>base_url<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">?client_id=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>clientId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;redirect_uri=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>redirect_uri<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;scope=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>scope<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;response_type=code&amp;state=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>slug<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> onClick <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>href<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">className</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">'button is-link'</span><span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>onClick<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">className</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">'icon'</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Image</span></span> <span class=\"token attr-name\">fileName</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">'google.png'</span><span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">alt</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">'google'</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Sign Up With Google</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> GoogleAuth<span class=\"token punctuation\">;</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Googleの認証エンドポイントにアクセスする際にstateというクエリパラメータを指定すると、APIサーバーへのリダイレクト発生時に、指定したstateクエリパラメータが認証コードと共にそのまま送られます。</p>\n<p>今回は、ログイン前とログイン後で表示されているページが同じになるようにしたかったので、stateパラメータにログイン後表示してほしいページを表すslug文字列を指定しています。</p>\n<p>以下、バックエンド側でコールバックを処理するLambda関数の一部を記載します。\npythonで記述しており、Flaskというライブラリを使用しています。</p>\n<div class=\"gatsby-code-title\">callback.py</div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\">\nuser_repository <span class=\"token operator\">=</span> UserRepository<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nrefresh_token_repository <span class=\"token operator\">=</span> RefreshTokenRepository<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/path/to/callback'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_handler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        code <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'code'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n        state <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'state'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> code <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'code is None'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># google oauth apiからaccess tokenを取得する。</span>\n        <span class=\"token comment\"># id tokenの署名もチェックする。</span>\n        access_token <span class=\"token operator\">=</span> google_auth_utils<span class=\"token punctuation\">.</span>get_access_token<span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> access_token <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'failed to get access token'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># google oauth apiからuser infoを取得する。</span>\n        user_info <span class=\"token operator\">=</span> google_auth_utils<span class=\"token punctuation\">.</span>get_user_info<span class=\"token punctuation\">(</span>access_token<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> user_info <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'failed to get user info'</span><span class=\"token punctuation\">)</span>\n\n        name <span class=\"token operator\">=</span> user_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n        email <span class=\"token operator\">=</span> user_info<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'email'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> name <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span> <span class=\"token keyword\">or</span> email <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'name or email is invalid'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># すでにemailが登録されているかどうか確認し、登録されていなければ新しく作成する。</span>\n        user <span class=\"token operator\">=</span> user_repository<span class=\"token punctuation\">.</span>get_user<span class=\"token punctuation\">(</span>email<span class=\"token operator\">=</span>email<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> user <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            user <span class=\"token operator\">=</span> user_repository<span class=\"token punctuation\">.</span>create_user<span class=\"token punctuation\">(</span>email<span class=\"token operator\">=</span>email<span class=\"token punctuation\">,</span> name<span class=\"token operator\">=</span>name<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> user <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'failed to create user'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># refresh_tokenを新しく作成する。</span>\n        refresh_token <span class=\"token operator\">=</span> refresh_token_repository<span class=\"token punctuation\">.</span>publish_token<span class=\"token punctuation\">(</span>user_id<span class=\"token operator\">=</span>user<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> refresh_token <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'failed to publish refresh token'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># refresh_tokenをcookieとして設定し、ユーザーが元いたページにredirectする。</span>\n        res <span class=\"token operator\">=</span> redirect<span class=\"token punctuation\">(</span>location<span class=\"token operator\">=</span><span class=\"token string\">\"http://www.takigawa-memo.com{}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        max_age <span class=\"token operator\">=</span> refresh_token_repository<span class=\"token punctuation\">.</span>ttl\n        res<span class=\"token punctuation\">.</span>set_cookie<span class=\"token punctuation\">(</span><span class=\"token string\">'refresh_token'</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">=</span>refresh_token<span class=\"token punctuation\">,</span> max_age<span class=\"token operator\">=</span>max_age<span class=\"token punctuation\">,</span> path<span class=\"token operator\">=</span><span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">,</span> httponly<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n                       secure<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> samesite<span class=\"token operator\">=</span><span class=\"token string\">\"Lax\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> res\n\n    <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>traceback<span class=\"token punctuation\">.</span>format_exc<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> get_error_response<span class=\"token punctuation\">(</span><span class=\"token string\">\"failed to handle google auth redirect\"</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"lambdaとdynamodbでsession管理\" style=\"position:relative;\"><a href=\"#lambda%E3%81%A8dynamodb%E3%81%A7session%E7%AE%A1%E7%90%86\" aria-label=\"lambdaとdynamodbでsession管理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>LambdaとDynamoDBでsession管理</h2>\n<p>コメントの投稿や削除時にユーザーの識別を行うために、DynamoDBにsession管理用のテーブルを作成し、そこにsession idとidに紐づくユーザー情報等を保存するようにしました。</p>\n<p>サイトの初回読み込み時に、/loginパスに対してGETクエリを投げるとsessionが開始されます。<br>\nサーバー側ではCookieとして送信されたrefresh tokenの有効期限をチェックし、\n期限切れでなければ新しくsession idを発行、ユーザー情報と紐づけてDynamoDBのsession管理用のテーブルに保存、レスポンスヘッダのSet-Cookieを介してブラウザとsession idを共有します。</p>\n<p>Lambda関数をFlaskというライブラリを用いて作成していたので、以下のリポジトリを参考にFlaskのSessionInterfaceを継承したクラスを作成しsession情報の保存先をDynamo DBに差し替えるという方法で実装しました。<br>\n<a href=\"https://github.com/ibejohn818/flask-dynamodb-sessions\">https://github.com/ibejohn818/flask-dynamodb-sessions</a></p>\n<p>以下ソースコードの一部を添付します。</p>\n<div class=\"gatsby-code-title\">session.py</div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\">\n<span class=\"token comment\"># https://github.com/ibejohn818/flask-dynamodb-sessions</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Session</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> app<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> app <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'app is None'</span><span class=\"token punctuation\">)</span>\n\n        table_name <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">'SessionIdTableName'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sessionId'</span><span class=\"token punctuation\">)</span>\n        ttl_seconds <span class=\"token operator\">=</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">30</span>\n\n        kw <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">'table'</span><span class=\"token punctuation\">:</span> table_name<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'ttl'</span><span class=\"token punctuation\">:</span> ttl_seconds<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n\n        interface <span class=\"token operator\">=</span> DynamodbSessionInterface<span class=\"token punctuation\">(</span><span class=\"token operator\">**</span>kw<span class=\"token punctuation\">)</span>\n\n        app<span class=\"token punctuation\">.</span>session_interface <span class=\"token operator\">=</span> interface\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">DynamodbSessionInterface</span><span class=\"token punctuation\">(</span>SessionInterface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    \"\"\"</span>\n    _boto_client <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kw<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>table <span class=\"token operator\">=</span> kw<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'table'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sessionId'</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>ttl <span class=\"token operator\">=</span> kw<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'ttl'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">open_session</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> app<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        \"\"\"</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open_session called\"</span><span class=\"token punctuation\">)</span>\n        sid <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>cookies<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">.</span>session_cookie_name<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># まだsession idが発行されていない。</span>\n        <span class=\"token keyword\">if</span> sid <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            sid <span class=\"token operator\">=</span> secrets<span class=\"token punctuation\">.</span>token_urlsafe<span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> DynamodbSession<span class=\"token punctuation\">(</span>sid<span class=\"token operator\">=</span>sid<span class=\"token punctuation\">)</span>\n\n        item <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>dynamo_get<span class=\"token punctuation\">(</span>sid<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># DB上にsession idに紐づくデータが保存されてない。</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> item<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> DynamodbSession<span class=\"token punctuation\">(</span>sid<span class=\"token operator\">=</span>sid<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># session idの期限切れ</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span>\n        now <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>datetime<span class=\"token punctuation\">.</span>utcnow<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>timestamp<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        ttl <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'ttl'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> ttl <span class=\"token operator\">&lt;</span> now<span class=\"token punctuation\">:</span>\n            self<span class=\"token punctuation\">.</span>delete_session<span class=\"token punctuation\">(</span>session_id<span class=\"token operator\">=</span>sid<span class=\"token punctuation\">)</span>\n            sid <span class=\"token operator\">=</span> secrets<span class=\"token punctuation\">.</span>token_urlsafe<span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> DynamodbSession<span class=\"token punctuation\">(</span>sid<span class=\"token operator\">=</span>sid<span class=\"token punctuation\">)</span>\n\n        data <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>hydrate_session<span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'data'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> DynamodbSession<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> sid<span class=\"token operator\">=</span>sid<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">save_session</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> app<span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        \"\"\"</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"save_session called\"</span><span class=\"token punctuation\">)</span>\n        domain <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>get_cookie_domain<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span>\n        path <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>get_cookie_path<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span>\n\n        httponly <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>get_cookie_httponly<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span>\n        secure <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>get_cookie_secure<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span>\n        expires <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>get_expiration_time<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">)</span>\n        session_id <span class=\"token operator\">=</span> session<span class=\"token punctuation\">.</span>sid\n\n        <span class=\"token comment\"># sessionのdataに格納されているユーザー情報が変更された</span>\n        <span class=\"token keyword\">if</span> session<span class=\"token punctuation\">.</span>modified<span class=\"token punctuation\">:</span>\n            self<span class=\"token punctuation\">.</span>dynamo_save<span class=\"token punctuation\">(</span>session_id<span class=\"token punctuation\">,</span> <span class=\"token builtin\">dict</span><span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        res<span class=\"token punctuation\">.</span>set_cookie<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">.</span>session_cookie_name<span class=\"token punctuation\">,</span> session_id<span class=\"token punctuation\">,</span>\n                       expires<span class=\"token operator\">=</span>expires<span class=\"token punctuation\">,</span> httponly<span class=\"token operator\">=</span>httponly<span class=\"token punctuation\">,</span>\n                       domain<span class=\"token operator\">=</span>domain<span class=\"token punctuation\">,</span> path<span class=\"token operator\">=</span>path<span class=\"token punctuation\">,</span> secure<span class=\"token operator\">=</span>secure<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">pickle_session</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"Pickle the session object and base64 encode it\n            for storage as a dynamo string\n        \"\"\"</span>\n        pickled <span class=\"token operator\">=</span> pickle<span class=\"token punctuation\">.</span>dumps<span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">)</span>\n\n        canned <span class=\"token operator\">=</span> codecs<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span>pickled<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> canned\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">hydrate_session</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> session_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"Base64 decode string back to bytes and unpickle\n        \"\"\"</span>\n        uncanned <span class=\"token operator\">=</span> codecs<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span>session_data<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span>\n\n        pickled <span class=\"token operator\">=</span> pickle<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>uncanned<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> pickled\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">dynamo_get</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> session_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        \"\"\"</span>\n        <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n            res <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>session_id_table<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get_item<span class=\"token punctuation\">(</span>Key<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">:</span> session_id<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'Item'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DYNAMO SESSION GET ITEM ERR: \"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">None</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">dynamo_save</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> session_id<span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n            fields <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">'data'</span><span class=\"token punctuation\">:</span> self<span class=\"token punctuation\">.</span>pickle_session<span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">'modified'</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>datetime<span class=\"token punctuation\">.</span>utcnow<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">'ttl'</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>datetime<span class=\"token punctuation\">.</span>utcnow<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>timestamp<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> self<span class=\"token punctuation\">.</span>ttl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dynamo save'</span><span class=\"token punctuation\">,</span> fields<span class=\"token punctuation\">)</span>\n\n            attr_names <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n            attr_vals <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n            ud_exp <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n            <span class=\"token keyword\">for</span> k<span class=\"token punctuation\">,</span> v <span class=\"token keyword\">in</span> fields<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                attr <span class=\"token operator\">=</span> <span class=\"token string\">\"#attr_{}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span>\n                token <span class=\"token operator\">=</span> <span class=\"token string\">\":{}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span>\n                ud_exp<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">\"{} = {}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>attr<span class=\"token punctuation\">,</span> token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                attr_names<span class=\"token punctuation\">[</span>attr<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> k\n                attr_vals<span class=\"token punctuation\">[</span>token<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> v\n\n            self<span class=\"token punctuation\">.</span>session_id_table<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>update_item<span class=\"token punctuation\">(</span>Key<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">:</span> session_id<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                                                ExpressionAttributeNames<span class=\"token operator\">=</span>attr_names<span class=\"token punctuation\">,</span>\n                                                ExpressionAttributeValues<span class=\"token operator\">=</span>attr_vals<span class=\"token punctuation\">,</span>\n                                                UpdateExpression<span class=\"token operator\">=</span><span class=\"token string\">\"SET {}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\", \"</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>ud_exp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                                ReturnValues<span class=\"token operator\">=</span><span class=\"token string\">'NONE'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DYNAMO SESSION SAVE ERR: \"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">delete_session</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> session_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"delete session id\"</span><span class=\"token punctuation\">,</span> session_id<span class=\"token punctuation\">)</span>\n            self<span class=\"token punctuation\">.</span>session_id_table<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>delete_item<span class=\"token punctuation\">(</span>Key<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">:</span> session_id<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DYNAMO SESSION DELETE ERR: \"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">session_id_table</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span>_boto_client <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            self<span class=\"token punctuation\">.</span>_boto_client <span class=\"token operator\">=</span> boto3<span class=\"token punctuation\">.</span>resource<span class=\"token punctuation\">(</span><span class=\"token string\">'dynamodb'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>_boto_client<span class=\"token punctuation\">.</span>Table<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>table<span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>handler関数では以下のように利用します。</p>\n<div class=\"gatsby-code-title\">login.py</div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\">app <span class=\"token operator\">=</span> Flask<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span>\nSession<span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span>\n\nuser_repository <span class=\"token operator\">=</span> UserRepository<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nrefresh_token_repository <span class=\"token operator\">=</span> RefreshTokenRepository<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/login'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_handler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        refresh_token <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>cookies<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'refresh_token'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> refresh_token <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> get_unauthorized_response<span class=\"token punctuation\">(</span><span class=\"token string\">\"refresh token is null\"</span><span class=\"token punctuation\">)</span>\n\n        user_id <span class=\"token operator\">=</span> refresh_token_repository<span class=\"token punctuation\">.</span>get_user_id<span class=\"token punctuation\">(</span>refresh_token<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> user_id <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> get_unauthorized_response<span class=\"token punctuation\">(</span><span class=\"token string\">'invalid refresh token'</span><span class=\"token punctuation\">)</span>\n\n        session<span class=\"token punctuation\">[</span><span class=\"token string\">'user_id'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> user_id\n\n        user <span class=\"token operator\">=</span> user_repository<span class=\"token punctuation\">.</span>get_user<span class=\"token punctuation\">(</span>user_id<span class=\"token operator\">=</span>user_id<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> user <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> Exception<span class=\"token punctuation\">(</span><span class=\"token string\">'failed to get user. user_id={}'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>user_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"user\"</span><span class=\"token punctuation\">:</span> user<span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>traceback<span class=\"token punctuation\">.</span>format_exc<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> get_error_response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"一意なidの生成\" style=\"position:relative;\"><a href=\"#%E4%B8%80%E6%84%8F%E3%81%AAid%E3%81%AE%E7%94%9F%E6%88%90\" aria-label=\"一意なidの生成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>一意なIDの生成</h2>\n<p>ユーザーidやコメントidなど一意な数値を生成したい場合、MySQL等のデータベースではauto increment機能を使えば実現できます。</p>\n<p>DynamoDBには残念ながらauto increment機能は無いのですが、idを生成するためのテーブルを作成し、そのテーブルに対してatomicな更新を行うことで一意なIDを生成することが可能です。</p>\n<p>例えば以下のようなスキーマのテーブルに対して、</p>\n<div class=\"gatsby-code-title\">user-id.json</div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-json line-numbers\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"TableName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"userId\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"AttributeDefinitions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"AttributeName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"AttributeType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"N\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"KeySchema\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"AttributeName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"id\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"KeyType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HASH\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ProvisionedThroughput\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"ReadCapacityUnits\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"WriteCapacityUnits\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>以下のような読み書きを行います。</p>\n<div class=\"gatsby-code-title\">id_generator.py</div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-python line-numbers\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">IdGenerator</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> sequence_table<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>sequence_table <span class=\"token operator\">=</span> sequence_table\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">next_id</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">:</span>\n        res <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>sequence_table<span class=\"token punctuation\">.</span>update_item<span class=\"token punctuation\">(</span>\n            Key<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            UpdateExpression<span class=\"token operator\">=</span><span class=\"token string\">\"ADD #name :increment\"</span><span class=\"token punctuation\">,</span>\n            ExpressionAttributeNames<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n                <span class=\"token string\">'#name'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'sequence'</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            ExpressionAttributeValues<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\":increment\"</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            ReturnValues<span class=\"token operator\">=</span><span class=\"token string\">\"UPDATED_NEW\"</span>\n        <span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">[</span><span class=\"token string\">'Attributes'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'sequence'</span><span class=\"token punctuation\">]</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2 id=\"期限切れsession-idの自動削除\" style=\"position:relative;\"><a href=\"#%E6%9C%9F%E9%99%90%E5%88%87%E3%82%8Csession-id%E3%81%AE%E8%87%AA%E5%8B%95%E5%89%8A%E9%99%A4\" aria-label=\"期限切れsession idの自動削除 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>期限切れsession idの自動削除</h2>\n<p>DynamoDBには特定の属性にUNIXエポック時間形式のタイムスタンプを格納しておくことで、その時間を過ぎると自動で項目を削除してくれる機能があります。</p>\n<p>有効期限を過ぎたsession idやrefresh tokenはその機能を用いて自動削除を行うようにしました。</p>\n<p>自動削除を有効化するには例えばtemplateファイルでDynamoDBのテーブルリソースを以下のように設定します。</p>\n<div class=\"gatsby-code-title\">template.yml</div>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yml line-numbers\"><code class=\"language-yml\">  <span class=\"token key atrule\">SessionIdTable</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> AWS<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>DynamoDB<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Table\n    <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">AttributeDefinitions</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">AttributeName</span><span class=\"token punctuation\">:</span> id\n          <span class=\"token key atrule\">AttributeType</span><span class=\"token punctuation\">:</span> S\n      <span class=\"token key atrule\">KeySchema</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">AttributeName</span><span class=\"token punctuation\">:</span> id\n          <span class=\"token key atrule\">KeyType</span><span class=\"token punctuation\">:</span> HASH\n      <span class=\"token key atrule\">ProvisionedThroughput</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">ReadCapacityUnits</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n        <span class=\"token key atrule\">WriteCapacityUnits</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n      <span class=\"token key atrule\">TimeToLiveSpecification</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">AttributeName</span><span class=\"token punctuation\">:</span> ttl\n        <span class=\"token key atrule\">Enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>これで、属性名ttlで指定した時刻を過ぎた項目は自動削除されます。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>以上、お粗末ではありますが簡単なコメント投稿機能を実装することができました。<br>\nログアウト機能がなかったり、投稿失敗時のエラーハンドリングをちゃんとしてなかったりと色々とガバガバですが、とりあえず今のところ問題なく機能しています。<br>\n当たり前ですが、GKEにデプロイした際は環境を作成しただけで毎日900円程度のコストがかかっていたのが、サーバレスな構成にするとコスト0で実現できました。<br>\nまた、時間があればお問い合わせ機能などもブログに追加してみたいと思います。</p>\n<h2 id=\"参考リンク\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83%E3%83%AA%E3%83%B3%E3%82%AF\" aria-label=\"参考リンク permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考リンク</h2>\n<ul>\n<li><a href=\"https://github.com/ibejohn818/flask-dynamodb-sessions\">https://github.com/ibejohn818/flask-dynamodb-sessions</a></li>\n<li><a href=\"https://qiita.com/TakahikoKawasaki/items/e37caf50776e00e733be\">一番分かりやすい OAuth の説明 - Qiita</a></li>\n<li><a href=\"https://qiita.com/kite_999/items/bddd62c395f260e745bc\">Google OAuth 2.0 認証を使ったログインの実装 - Qiita</a></li>\n<li><a href=\"https://qiita.com/horike37/items/dc81442d5d1b8ea89325\">ログイン・ログアウト機能をサーバレスアーキテクチャで実装する - Qiita</a></li>\n<li><a href=\"https://dev.classmethod.jp/articles/try-dynamodb-ttl/\">DynamoDBの各データを自動で削除する機能（TTL:Time to Live）を試してみた | DevelopersIO</a></li>\n</ul>","toc":"<ul>\n<li><a href=\"#%E3%81%93%E3%82%8C%E3%81%AF%E4%BD%95\">これは何</a></li>\n<li><a href=\"#%E5%88%9D%E3%82%81%E3%81%AB\">初めに</a></li>\n<li><a href=\"#%E4%BB%95%E6%A7%98\">仕様</a></li>\n<li><a href=\"#%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E6%A7%8B%E6%88%90%E5%9B%B3\">インフラ構成図</a></li>\n<li><a href=\"#google-oauth-20%E3%82%92%E7%94%A8%E3%81%84%E3%81%9F%E8%AA%8D%E8%A8%BC\">Google Oauth 2.0を用いた認証</a></li>\n<li><a href=\"#lambda%E3%81%A8dynamodb%E3%81%A7session%E7%AE%A1%E7%90%86\">LambdaとDynamoDBでsession管理</a></li>\n<li><a href=\"#%E4%B8%80%E6%84%8F%E3%81%AAid%E3%81%AE%E7%94%9F%E6%88%90\">一意なIDの生成</a></li>\n<li><a href=\"#%E6%9C%9F%E9%99%90%E5%88%87%E3%82%8Csession-id%E3%81%AE%E8%87%AA%E5%8B%95%E5%89%8A%E9%99%A4\">期限切れsession idの自動削除</a></li>\n<li><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\">まとめ</a></li>\n<li><a href=\"#%E5%8F%82%E8%80%83%E3%83%AA%E3%83%B3%E3%82%AF\">参考リンク</a></li>\n</ul>"},"site":{"siteMetadata":{"siteUrl":"https://www.takigawa-memo.com"}}},"pageContext":{"slug":"/gatsby-google-oauth-sam/"}},"staticQueryHashes":["112949366","706912905"]}